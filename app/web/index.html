<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èµ¤ã¡ã‚ƒã‚“è¦‹å®ˆã‚Šã‚«ãƒ¡ãƒ© (HLS)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f7f7f9; color: #222; }
    header { padding: 16px; text-align: center; background: #fff; border-bottom: 1px solid #e5e5e5; }
    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .player { background:#000; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    video { width: 100%; height: auto; display: block; }
    .panel { background:#fff; border:1px solid #e5e5e5; border-radius: 8px; padding: 16px; margin-top: 16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    input[type=text] { flex: 1 1 380px; padding: 10px 12px; border:1px solid #ccc; border-radius: 6px; font-size: 14px; }
    button { padding: 10px 16px; font-size: 14px; border:0; border-radius: 6px; background:#4f46e5; color:#fff; cursor: pointer; }
    button.secondary { background:#0f766e; }
    .hint { color:#555; font-size: 13px; margin-top:8px; }
    footer { text-align:center; color:#777; font-size: 12px; padding: 24px 0; }
    a { color:#0ea5e9; text-decoration: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ‘¶ èµ¤ã¡ã‚ƒã‚“è¦‹å®ˆã‚Šã‚«ãƒ¡ãƒ© â€“ HLSãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h1>
  </header>
  <main>
    <section class="player">
      <video id="video" controls autoplay playsinline muted crossorigin="anonymous"></video>
    </section>

    <section class="panel">
      <h3>ã‚¹ãƒˆãƒªãƒ¼ãƒ é¸æŠ</h3>
      <div class="row">
        <label for="m3u8" style="min-width:88px">HLS URL</label>
        <input id="m3u8" type="text" placeholder="/hls/cam/index.m3u8" />
        <button onclick="play()">å†ç”Ÿ</button>
        <button class="secondary" onclick="loadDefault()">æ—¢å®šã®URLã‚’ã‚»ãƒƒãƒˆ</button>
      </div>
      <p class="hint">
        æ—¢å®š: åŒä¸€ã‚ªãƒªã‚¸ãƒ³ <code>/hls/cam/index.m3u8</code>ï¼ˆNginx â†’ MediaMTX:8888 ã«ãƒ—ãƒ­ã‚­ã‚·ï¼‰ã‚’å†ç”Ÿã—ã¾ã™ã€‚<br />
        å…ˆã« <code>docker compose up -d</code> ã§èµ·å‹•ã—ã€<code>.env</code> ã«æ­£ã—ã„ <code>RTSP_URL</code> ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
      </p>
      <p class="hint">
        ä½é…å»¶ã§è¦‹ãŸã„å ´åˆã¯ WebRTC ã‚‚è©¦ã›ã¾ã™ â†’
        <a href="http://localhost:8889/" target="_blank" rel="noopener">MediaMTX WebRTC ãƒ“ãƒ¥ãƒ¼ã‚¢</a>
      </p>
    </section>

    <section class="panel">
      <h3>AI è§£æï¼ˆGeminiï¼‰</h3>
      <div class="row" style="margin-bottom:8px;">
        <label for="ai-prompt" style="min-width:88px">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <input id="ai-prompt" type="text" placeholder="èµ¤ã¡ã‚ƒã‚“ã®å®‰å…¨ã‚„å¿«é©ã•ã®è¦³ç‚¹ã§æ°—ã¥ã„ãŸç‚¹ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«" />
        <button onclick="analyzeCurrentFrame()">ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è§£æ</button>
      </div>
      <div>
        <strong>çµæœ</strong>
        <pre id="ai-result" style="white-space:pre-wrap; background:#f8fafc; border:1px solid #e5e7eb; padding:12px; border-radius:6px; min-height:80px;"></pre>
      </div>
      <canvas id="snap" style="display:none;"></canvas>
    </section>
  </main>
  <footer>
    <p>Powered by MediaMTX (RTSPâ†’HLS/WebRTC) + Nginx</p>
  </footer>

  <script>
    const video = document.getElementById('video');
    const input = document.getElementById('m3u8');

    function defaultUrl() {
      // åŒä¸€ã‚ªãƒªã‚¸ãƒ³é…ä¸‹ã«ãƒ—ãƒ­ã‚­ã‚·ã—ãŸHLSï¼ˆNginx -> mediamtxï¼‰
      return `/hls/cam/index.m3u8`;
    }

    function loadDefault() {
      input.value = defaultUrl();
    }

    function play() {
      const url = input.value.trim();
      if (!url) {
        alert('HLSã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (Hls.isSupported()) {
        const hls = new Hls({lowLatencyMode: true});
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          video.play().catch(()=>{});
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari (iOS/macOS)
        video.src = url;
        video.play().catch(()=>{});
      } else {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯HLSå†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      }
    }

    async function analyzeCurrentFrame() {
      const host = window.location.hostname || 'localhost';
      const url = `http://${host}:8081/analyze`;

      const canvas = document.getElementById('snap');
      const ctx = canvas.getContext('2d');
      if (!video.videoWidth || !video.videoHeight) {
        alert('å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚å†ç”Ÿä¸­ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const prompt = document.getElementById('ai-prompt').value.trim();
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      const fd = new FormData();
      fd.append('image', blob, 'frame.jpg');
      if (prompt) fd.append('prompt', prompt);

      const out = document.getElementById('ai-result');
      out.textContent = 'è§£æä¸­â€¦';
      try {
        const res = await fetch(url, { method: 'POST', body: fd });
        const data = await res.json();
        if (data.error) {
          out.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error} (status=${data.status || ''})`;
        } else {
          out.textContent = data.text || '[çµæœãªã—]';
        }
      } catch (e) {
        out.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e}`;
      }
    }

    // åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
    loadDefault();
  </script>
</body>
</html>
