<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini Baby Monitor</title>
  <meta name="description" content="ブラウザで赤ちゃんの様子を安全に見守れるHLS/WebRTC対応のライブモニター。AI解析で安全チェックを支援し、低遅延・高画質でいつでもどこでも確認できます。" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />
  <!-- HLS.js for HLS playback -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
  <style>
    html,body{height:100%}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  </style>
  
</head>
<body class="min-h-screen bg-slate-900 text-white antialiased">
  <!-- 背景: WebGL Fluid（GUIなし、常時ループ） -->
  <canvas id="fluid-canvas" class="fixed inset-0 -z-10 w-full h-full"></canvas>
  <!-- 可読性オーバーレイ -->
  <div class="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(ellipse_at_top,rgba(0,0,0,0.45),rgba(0,0,0,0.78))]"></div>

  <!-- ヘッダー（アプリ用に簡素化） -->
  <header class="fixed top-0 left-0 right-0 z-40">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4">
      <div class="flex items-center gap-3">
        <div class="grid h-9 w-9 place-items-center rounded-2xl bg-white/10 ring-1 ring-white/20 backdrop-blur shadow-md">
          <i class="fa-solid fa-baby text-lg text-white/90" aria-hidden="true"></i>
        </div>
        <span class="text-lg font-semibold text-white/90">Gemini Baby Monitor</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="motionToggle" class="flex items-center gap-2 rounded-xl bg-white/10 px-4 py-2 text-white ring-1 ring-white/20 transition hover:bg-white/20" type="button" aria-label="背景アニメーションの設定" aria-pressed="false">
          <i class="fa-solid fa-minus-circle text-sm" aria-hidden="true"></i>
          <span class="whitespace-nowrap">動きを少なくする</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ヒーロー: アプリ画面に不要のため削除 -->

  <!-- ライブモニター（HLSプレイヤー + AI解析） -->
  <section id="monitor" class="mx-auto max-w-7xl px-4 pt-28 pb-20">
    <div class="mb-12 text-center">
      <h1 class="text-4xl font-bold tracking-tight text-white md:text-6xl">Gemini Baby Monitor</h1>
    </div>
    <div class="mb-8 text-center">
      <h2 class="mx-auto flex max-w-max items-center justify-center gap-3 text-2xl font-bold md:text-3xl">
        <i class="fa-solid fa-tv text-xl" aria-hidden="true"></i>
        <span>ライブモニター</span>
      </h2>
      <p class="mt-2 text-white/70 text-sm md:text-base">同一オリジン <code class="text-white/90">/hls/cam/index.m3u8</code> を再生。低遅延は WebRTC ビューアをご利用ください。</p>
    </div>
    <div class="grid gap-6 md:grid-cols-2">
      <!-- Player Card -->
      <div class="rounded-2xl border border-white/10 bg-black/60 p-3 backdrop-blur-xl shadow-[0_8px_40px_rgba(0,0,0,0.35)]">
        <div class="aspect-video w-full overflow-hidden rounded-xl ring-1 ring-white/10 bg-black">
          <video id="video" class="h-full w-full" controls autoplay playsinline muted crossorigin="anonymous"></video>
        </div>
        <div class="mt-3 text-xs text-white/60">Powered by MediaMTX (RTSP→HLS/WebRTC)</div>
        <div class="mt-4 flex flex-col gap-3 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <button id="recordToggle" type="button" class="flex w-full items-center justify-center gap-2 rounded-lg bg-rose-500/90 px-4 py-2 text-sm font-semibold text-rose-50 transition hover:bg-rose-400 sm:w-auto" aria-pressed="false">
              <i class="fa-solid fa-circle-dot text-sm" aria-hidden="true"></i>
              <span>録画を開始</span>
            </button>
            <div id="recordStatus" class="text-xs text-white/70">未録画</div>
          </div>
          <a id="recordDownload" class="hidden rounded-lg bg-white/10 px-4 py-2 text-center text-xs font-medium text-white ring-1 ring-white/10 transition hover:bg-white/20" download>
            録画ファイルをダウンロード
          </a>
        </div>
      </div>

      <div class="space-y-6">
        <!-- Stream controls -->
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-white/90">
            <i class="fa-solid fa-signal text-base" aria-hidden="true"></i>
            <span>ストリーム選択</span>
          </h3>
          <div class="mt-4 flex flex-col gap-3 sm:flex-row">
            <input id="m3u8" type="text" placeholder="/hls/cam/index.m3u8" class="w-full flex-1 rounded-xl border border-white/10 bg-black/30 px-4 py-3 text-sm placeholder-white/40 outline-none ring-1 ring-white/10 focus:ring-2 focus:ring-cyan-300/50" />
            <div class="flex gap-2">
              <button onclick="play()" class="flex items-center gap-2 rounded-xl bg-white px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg transition hover:shadow-xl" type="button">
                <i class="fa-solid fa-play text-xs" aria-hidden="true"></i>
                <span>再生</span>
              </button>
              <button onclick="loadDefault()" class="flex items-center gap-2 rounded-xl bg-white/10 px-5 py-3 text-sm text-white ring-1 ring-white/20 transition hover:bg-white/20" type="button">
                <i class="fa-solid fa-rotate-right text-xs" aria-hidden="true"></i>
                <span>既定URL</span>
              </button>
            </div>
          </div>
          <div class="mt-3 flex flex-col gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center gap-2 text-sm text-white/80">
              <i class="fa-solid fa-film text-xs" aria-hidden="true"></i>
              <span>デモモード（サンプル映像を再生）</span>
            </div>
            <button id="demoToggle" type="button" class="flex items-center justify-center gap-2 rounded-lg border border-white/20 px-3 py-2 text-xs font-semibold text-white/80 transition hover:bg-white/10" aria-pressed="false">
              <i class="fa-solid fa-toggle-off text-base" aria-hidden="true"></i>
              <span>OFF</span>
            </button>
          </div>
          <p class="mt-3 text-xs text-white/60">
            先に <code class="text-white/90">docker compose up -d</code> と <code class="text-white/90">.env</code> の <code class="text-white/90">RTSP_URL</code> 設定をご確認ください。
            WebRTC ビューア: <a class="underline hover:text-white" href="http://localhost:8889/" target="_blank" rel="noopener">http://localhost:8889/</a>
          </p>
        </div>

        <!-- AI analysis -->
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-white/90">
            <i class="fa-solid fa-robot text-base" aria-hidden="true"></i>
            <span>AI 解析（Gemini）</span>
          </h3>
          <div class="mt-4 flex flex-col gap-3 sm:flex-row">
            <input id="ai-prompt" type="text" placeholder="赤ちゃんの安全や快適さの観点で気づいた点を日本語で簡潔に" class="w-full flex-1 rounded-xl border border-white/10 bg-black/30 px-4 py-3 text-sm placeholder-white/40 outline-none ring-1 ring-white/10 focus:ring-2 focus:ring-cyan-300/50" />
            <button onclick="analyzeCurrentFrame()" class="flex items-center gap-2 rounded-xl bg-emerald-400/90 px-5 py-3 text-sm font-semibold text-emerald-950 shadow-lg transition hover:bg-emerald-300" type="button">
              <i class="fa-solid fa-magnifying-glass text-sm" aria-hidden="true"></i>
              <span>現在のフレームを解析</span>
            </button>
          </div>
          <div class="mt-3">
            <div class="flex items-center gap-2 text-sm font-medium text-white/90">
              <i class="fa-solid fa-clipboard-check text-xs" aria-hidden="true"></i>
              <span>結果</span>
            </div>
            <pre id="ai-result" class="mt-2 min-h-[88px] whitespace-pre-wrap rounded-xl border border-white/10 bg-black/30 p-3 text-sm text-white/80 ring-1 ring-white/10"></pre>
          </div>
          <canvas id="snap" class="hidden"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- 機能: アプリ画面に不要のため削除 -->

  <!-- セキュリティ: アプリ画面に不要のため削除 -->

  <!-- 利用シーン: アプリ画面に不要のため削除 -->

  <!-- CTA: アプリ画面に不要のため削除 -->

  <!-- フッター: アプリ画面に不要のため削除 -->

  <!-- MITクレジット -->
  <div class="fixed bottom-3 right-3 z-40 text-[10px] text-white/60">
    Background: WebGL Fluid Simulation by PavelDoGreat (MIT)
  </div>

  <script type="module">
    // 年表示（フッター削除に伴い未使用）
    // const yearEl = document.getElementById('year');
    // if (yearEl) yearEl.textContent = new Date().getFullYear();

    // 実行時 import（CDNフォールバック付き）
    const importFromUrl = async (u) => new Function('u','return import(u)')(u);
    const CDN_PRIMARY = 'https://cdn.skypack.dev/' + 'webgl-fluid';
    const CDN_FALLBACK = 'https://esm.sh/webgl-fluid';

    let WebglFluid = null;
    try {
      WebglFluid = (await importFromUrl(CDN_PRIMARY)).default;
    } catch {
      WebglFluid = (await importFromUrl(CDN_FALLBACK)).default;
    }

    // Canvasを固定背景化
    const canvas = document.getElementById('fluid-canvas');
    Object.assign(canvas.style, { position:'fixed', inset:'0px', width:'100%', height:'100%', zIndex:'-10' });

    // reduced-motion
    const mq = matchMedia('(prefers-reduced-motion: reduce)');
    let reduced = mq.matches;

    const initFluid = () => {
      if (reduced) return;
      WebglFluid(canvas, {
        IMMEDIATE: true, TRANSPARENT: true, TRIGGER:'hover',
        DYE_RESOLUTION: 1024, SIM_RESOLUTION: 128,
        PRESSURE_ITERATIONS: 20, VELOCITY_DISSIPATION: 0.2, DENSITY_DISSIPATION: 1.0,
        CURL: 30, SPLAT_RADIUS: 0.24, SPLAT_FORCE: 6000, BLOOM: true, BLOOM_INTENSITY: 0.8,
        BLOOM_THRESHOLD: 0.6, SUNRAYS: true, PAUSED: false,
      });
    };
    initFluid();

    // 常時ループ（擬似スプラット）
    let timer = null;
    const startLoop = () => {
      if (reduced) return;
      stopLoop();
      timer = setInterval(() => {
        const r = canvas.getBoundingClientRect();
        const x = r.left + Math.random() * r.width;
        const y = r.top + Math.random() * r.height;
        canvas.dispatchEvent(new MouseEvent('mousemove', { clientX:x, clientY:y, bubbles:true, cancelable:true }));
      }, 1200);
    };
    const stopLoop = () => { if (timer) { clearInterval(timer); timer = null; } };
    startLoop();

    // トグル
    const toggleBtn = document.getElementById('motionToggle');
    const renderMotionLabel = () => {
      if (reduced) {
        return '<i class="fa-solid fa-play-circle text-sm" aria-hidden="true"></i><span class="whitespace-nowrap">背景アニメーションを有効化</span>';
      }
      return '<i class="fa-solid fa-minus-circle text-sm" aria-hidden="true"></i><span class="whitespace-nowrap">動きを少なくする</span>';
    };
    const apply = () => {
      canvas.style.display = reduced ? 'none' : 'block';
      toggleBtn.innerHTML = renderMotionLabel();
      toggleBtn.setAttribute('aria-pressed', String(!reduced));
    };
    apply();
    toggleBtn.addEventListener('click', () => { reduced = !reduced; apply(); if(!reduced){ initFluid(); startLoop(); } else { stopLoop(); }});
    mq.addEventListener?.('change', (e) => { reduced = e.matches; apply(); if(!reduced){ initFluid(); startLoop(); } else { stopLoop(); }});

    // 超ミニテスト
    const tests = [];
    const add = (n,p,m) => { tests.push({n,p,m}); if(!p) console.error('[TEST FAIL]', n, m||''); };
    add('import default export is function', typeof WebglFluid === 'function');
    add('canvas exists', !!canvas);
    add('loop timer started', typeof timer === 'number');
    setTimeout(() => { if(!reduced) add('canvas visible', canvas.style.display!=='none'); window.__fluid_tests__ = tests; }, 3000);
  </script>
  
  <!-- HLSプレイヤー + AI解析 ロジック -->
  <script>
    const video = document.getElementById('video');
    const input = document.getElementById('m3u8');
    const demoToggle = document.getElementById('demoToggle');
    const recordBtn = document.getElementById('recordToggle');
    const recordStatus = document.getElementById('recordStatus');
    const recordDownload = document.getElementById('recordDownload');

    const DEMO_VIDEO_URL = '/demo/baby-monitor-2025-09-23T13-42-04-819Z.webm';

    let mediaRecorder = null;
    let recordedChunks = [];
    let recording = false;
    let recordUrl = null;
    let demoMode = false;
    let hlsInstance = null;

    const setRecordStatus = (message) => { if (recordStatus) recordStatus.textContent = message; };

    const updateRecordButton = () => {
      if (!recordBtn) return;
      const icon = recording ? 'fa-stop' : 'fa-circle-dot';
      const label = recording ? '録画を停止' : '録画を開始';
      recordBtn.innerHTML = `<i class="fa-solid ${icon} text-sm" aria-hidden="true"></i><span>${label}</span>`;
      recordBtn.setAttribute('aria-pressed', String(recording));
      recordBtn.classList.toggle('bg-rose-500/90', !recording);
      recordBtn.classList.toggle('hover:bg-rose-400', !recording);
      recordBtn.classList.toggle('bg-amber-500', recording);
      recordBtn.classList.toggle('hover:bg-amber-400', recording);
    };

    const supportsRecording = () => typeof MediaRecorder !== 'undefined' && (typeof video.captureStream === 'function' || typeof video.mozCaptureStream === 'function');

    const destroyHls = () => {
      if (hlsInstance) {
        try {
          hlsInstance.destroy();
        } catch (err) {
          console.warn('Failed to destroy HLS instance', err);
        }
        hlsInstance = null;
      }
    };

    const getVideoStream = () => {
      if (typeof video.captureStream === 'function') return video.captureStream();
      if (typeof video.mozCaptureStream === 'function') return video.mozCaptureStream();
      return null;
    };

    const resetDownloadLink = () => {
      if (recordDownload) {
        recordDownload.classList.add('hidden');
        if (recordUrl) {
          URL.revokeObjectURL(recordUrl);
          recordUrl = null;
        }
        recordDownload.removeAttribute('href');
        recordDownload.removeAttribute('download');
        recordDownload.textContent = '録画ファイルをダウンロード';
      }
    };

    const updateDemoToggle = () => {
      if (!demoToggle) return;
      const icon = demoMode ? 'fa-toggle-on text-emerald-300' : 'fa-toggle-off';
      const label = demoMode ? 'ON' : 'OFF';
      demoToggle.innerHTML = `<i class="fa-solid ${icon} text-base" aria-hidden="true"></i><span>${label}</span>`;
      demoToggle.setAttribute('aria-pressed', String(demoMode));
      demoToggle.classList.toggle('bg-emerald-500/20', demoMode);
      demoToggle.classList.toggle('text-white', demoMode);
    };

    const applyDemoState = () => {
      if (input) {
        input.disabled = demoMode;
        input.classList.toggle('opacity-50', demoMode);
        if (demoMode) {
          input.value = 'デモモード使用中';
        } else {
          input.value = input.value === 'デモモード使用中' ? '' : input.value;
        }
      }
      updateDemoToggle();
    };

    const handleRecorderStop = () => {
      if (!recordDownload || recordedChunks.length === 0) {
        setRecordStatus('録画データが取得できませんでした。');
        mediaRecorder = null;
        recording = false;
        updateRecordButton();
        return;
      }

      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      recordUrl = URL.createObjectURL(blob);
      const filename = `baby-monitor-${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
      recordDownload.href = recordUrl;
      recordDownload.download = filename;
      recordDownload.textContent = `録画を保存 (${filename})`;
      recordDownload.classList.remove('hidden');
      setRecordStatus('録画完了。保存リンクをご利用ください。');
      recordedChunks = [];
      mediaRecorder = null;
      recording = false;
      updateRecordButton();
      if (typeof recordDownload.focus === 'function') {
        recordDownload.focus();
      }
    };

    const playDemo = async () => {
      destroyHls();
      try {
        video.pause();
      } catch (err) {
        /* ignore */
      }
      video.removeAttribute('src');
      video.load();
      video.loop = true;
      video.src = DEMO_VIDEO_URL;
      try {
        await video.play();
      } catch (err) {
        console.warn('Demo playback failed', err);
      }
      setRecordStatus(demoMode ? 'デモ映像再生中。必要に応じて録画可能です。' : recordStatus?.textContent || '');
    };

    const startRecording = () => {
      if (!supportsRecording()) {
        alert('このブラウザは録画に対応していません。');
        return;
      }
      if (recording) return;
      if (!video || video.readyState < 2) {
        alert('録画を開始する前に動画を再生してください。');
        return;
      }
      const stream = getVideoStream();
      if (!stream) {
        alert('録画用のストリームを取得できませんでした。');
        return;
      }

      resetDownloadLink();
      recordedChunks = [];

      try {
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9,opus' });
      } catch (err) {
        try {
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
        } catch (fallbackErr) {
          console.error('MediaRecorder init failed', fallbackErr);
          alert('録画の初期化に失敗しました。ブラウザ設定を確認してください。');
          return;
        }
      }

      mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = handleRecorderStop;
      mediaRecorder.onerror = (event) => {
        console.error('Recording error', event);
        setRecordStatus(`録画エラー: ${event.error?.message || event.name || '不明なエラー'}`);
        recording = false;
        mediaRecorder = null;
        resetDownloadLink();
        updateRecordButton();
      };

      try {
        mediaRecorder.start();
        recording = true;
        setRecordStatus('録画中…');
        updateRecordButton();
      } catch (err) {
        console.error('MediaRecorder start failed', err);
        alert('録画の開始に失敗しました。');
      }
    };

    const stopRecording = () => {
      if (!mediaRecorder || !recording) return;
      try {
        mediaRecorder.stop();
        setRecordStatus('録画を処理中…');
      } catch (err) {
        console.error('Failed to stop recorder', err);
        setRecordStatus('録画の停止に失敗しました。');
      }
      recording = false;
      updateRecordButton();
    };

    if (recordBtn) {
      if (!supportsRecording()) {
        recordBtn.disabled = true;
        recordBtn.classList.add('opacity-60', 'cursor-not-allowed');
        recordBtn.innerHTML = '<i class="fa-solid fa-ban text-sm" aria-hidden="true"></i><span>録画非対応</span>';
        setRecordStatus('ブラウザが録画に対応していません。Chrome や Edge の最新バージョンをご利用ください。');
      } else {
        updateRecordButton();
        setRecordStatus('未録画');
        recordBtn.addEventListener('click', () => {
          if (recording) {
            stopRecording();
          } else {
            startRecording();
          }
        });
      }
    }

    if (demoToggle) {
      applyDemoState();
      demoToggle.addEventListener('click', () => {
        if (recording) {
          stopRecording();
        }
        demoMode = !demoMode;
        applyDemoState();
        resetDownloadLink();
        if (demoMode) {
          setRecordStatus('デモ映像再生中。必要に応じて録画可能です。');
          playDemo();
        } else {
          setRecordStatus('未録画');
          video.loop = false;
          destroyHls();
          video.pause?.();
          video.removeAttribute('src');
          video.load();
          loadDefault();
        }
      });
    }

    window.addEventListener('beforeunload', () => {
      if (recordUrl) {
        URL.revokeObjectURL(recordUrl);
        recordUrl = null;
      }
      if (recording && mediaRecorder) {
        try {
          mediaRecorder.stop();
        } catch (err) {
          console.warn('Failed to stop recorder on unload', err);
        }
      }
    });

    function defaultUrl() {
      return `/hls/cam/index.m3u8`;
    }

    function loadDefault() {
      if (demoMode) return;
      if (input) input.value = defaultUrl();
    }

    function play() {
      if (demoMode) {
        playDemo();
        return;
      }

      const url = (input?.value || '').trim();
      if (!url) { alert('HLSのURLを入力してください'); return; }

      video.loop = false;
      destroyHls();

      if (window.Hls && Hls.isSupported()) {
        hlsInstance = new Hls({ lowLatencyMode: true });
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () { video.play().catch(()=>{}); });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play().catch(()=>{});
      } else {
        alert('このブラウザはHLS再生に対応していません');
      }
    }

    async function analyzeCurrentFrame() {
      const url = '/api/analyze';
      const canvas = document.getElementById('snap');
      const ctx = canvas.getContext('2d');
      if (!video.videoWidth || !video.videoHeight) {
        alert('動画フレームを取得できません。再生中か確認してください。');
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const prompt = document.getElementById('ai-prompt').value.trim();
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      const fd = new FormData();
      fd.append('image', blob, 'frame.jpg');
      if (prompt) fd.append('prompt', prompt);

      const out = document.getElementById('ai-result');
      out.textContent = '解析中…';
      try {
        const res = await fetch(url, { method: 'POST', body: fd });
        if (!res.ok) {
          const message = await res.text();
          out.textContent = `エラー: API応答が不正です (status=${res.status}) ${message || ''}`.trim();
          return;
        }
        const data = await res.json();
        if (data.error) {
          out.textContent = `エラー: ${data.error} (status=${data.status || ''})`;
        } else {
          out.textContent = data.text || '[結果なし]';
        }
      } catch (e) {
        out.textContent = `通信エラー: ${e}`;
      }
    }

    // 初期値をセット
    loadDefault();
  </script>
</body>
</html>
